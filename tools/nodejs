NODE_MAJOR=20

_node_current=$(node --version 2>/dev/null | grep -oP '\d+' | head -1 || echo 0)
if [ "$_node_current" -lt "$NODE_MAJOR" ]; then
  apt_get_install ca-certificates
  apt_get_install curl
  apt_get_install gnupg
  # Remove old system node packages that conflict with nodesource
  eval "$SUDO apt-get remove -y nodejs npm libnode-dev libnode72 2>/dev/null" || true
  eval "$SUDO apt-get autoremove -y 2>/dev/null" || true
  sudo mkdir -p /etc/apt/keyrings
  curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" \
    | sudo tee /etc/apt/sources.list.d/nodesource.list
  eval "$SUDO apt-get update -y"
  eval "$SUDO apt-get install -y nodejs"
fi

# When installing modules with npm always pin version
if _which npm; then
  npm config set save-prefix ''
fi
