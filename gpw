# This supports getting credentials from bitwarden
# and copying them to clipboard. It caches records
# if they don't exist and then uses that cache in
# the future
gpw() {
    # Use shared Bitwarden cache
    local CACHE_FILE=$(_bwEnsureCache)

    # Trap CTRL-C and clean up before exit
    trap "_bwCleanupCache; echo 'Exiting...'; exit 0" SIGINT

    # Process items and display with fzf (control characters already cleaned in cache)
    item=$(cat "$CACHE_FILE" | jq -r '.[] | "\(.name) | \(.login.username // "N/A") | \(.login.uris[0].uri // "N/A") | \(.id)"' | fzf --layout=reverse --height=40% --min-height=10)

    # Check if user cancelled item selection
    if [ -z "$item" ]; then
        _bwCleanupCache
        return 1
    fi

    # Extract item_id from the selected item
    item_id=$(echo "$item" | awk -F' | ' '{print $NF}')

    # Loop for selecting username, password, or totp
    while true; do
        attribute=$(echo -e "username\npassword\ntotp" | fzf --layout=reverse --height=40% --min-height=10)
        if [ -z "$attribute" ]; then
            echo "No attribute selected."
            _bwCleanupCache
            return 1
        fi

        # Extract the value from the cached data
        value=$(cat "$CACHE_FILE" | jq -r --arg id "$item_id" --arg attr "$attribute" '.[] | select(.id == $id) | .login[$attr] // empty')
        if [ -z "$value" ]; then
            echo "No value found for $attribute."
            _bwCleanupCache
            return 1
        fi

        echo "$value" | pbcopy
        echo "$attribute copied to clipboard."
    done
}
